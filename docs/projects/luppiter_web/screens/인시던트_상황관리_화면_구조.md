# Luppiter Web - 인시던트 상황관리 화면 구조

## 개요

본 문서는 Luppiter Web의 **인시던트 상황관리** 화면의 구조와 처리 흐름을 설명합니다.

---

## 화면 정보

- **URL**: `/view/icd/subIncidentState`
- **JSP 파일**: `icd/subIncidentState.jsp`
- **Controller**: `IcdController.java`
- **REST Controller**: `IcdRestController.java`

---

## 화면 구성 요소

### 1. 헤더 영역
- **제목**: 인시던트 상황 관리
- **기능 버튼**:
  - 소리끔/켬 버튼 (`btnSound`)
  - 엑셀다운로드 버튼 (`btnExcelDown`)
- **현재 시간 표시**: `printNowDateTime`

### 2. 실시간 조회 영역
- **실시간 체크박스**: `realCHK` (기본 체크됨, 숨김)
- **검색필터 체크박스**: `btnKeyword`
- **현재 조회 시간 표시**: `currCheckTime`
- **지금 업데이트 버튼**: `btnReload`

### 3. 검색 필터 영역 (`searchBox`)
- **조회기간**:
  - 조회 타입 선택: `searchType` (이벤트 발생시간/인시던트 종료시간)
  - 시작일/시간: `startDate`, `startTime`
  - 종료일/시간: `endDate`, `endTime`
  - 기간 선택 버튼: 1개월, 2개월, 3개월
- **레이어 필터**:
  - L1, L2, L3 선택: `commonL1`, `commonL2`, `commonL3`
  - Zone(L4): `zone`
- **인시던트 필터**:
  - 인시던트ID: `kwIncidentId`
  - 인시던트 등급: `kwIncidentLevel`
  - 인시던트 상태: `kwIncidentState` (조치중, 조치완료)
  - 관제상황조장: `kwCaptain`
  - 복구팀: `kwRestoreTeam`
  - 이벤트제목: `kwIncidentContents`
  - 센터: `kwContainerNm`
  - 표준서비스(L3): `kwStdnm`
  - ITSM인시던트ID: `kwItsmIncidentId`
  - 서비스영향도: `kwIncidentServiceImpact`
- **검색/초기화 버튼**: `btnSearch`, `btnSearchInit`

### 4. 그리드 영역
- **Toast UI Grid**: `grid`
- **페이지 크기 선택**: `slcPageSize` (20, 50, 75, 100, 200, 300, 전체)
- **액션 버튼**:
  - 등록: `btnIncidentCreate` (수동 인시던트 생성)
- **페이징**: `divPaging`

### 5. 인시던트 상세 팝업
- **팝업 ID**: `test-popup1`
- **팝업 파일**: `subIncidentStateDetailPopup.jsp`

---

## 처리 흐름

### 1단계: 화면 초기화

```
[페이지 로드]
    │
    ├─► 서버 시간 설정
    │   └─► IcdController.subIncidentState()
    │       └─► serverTime 설정
    │
    └─► JavaScript 초기화
        ├─► 그리드 초기화
        ├─► 첫 페이지 조회
        └─► 자동 갱신 설정
```

#### 주요 코드 위치
- **컨트롤러**: `IcdController.java:30-45`
- **초기화**: `subIncidentState.jsp:$(function(){...})`

### 2단계: 인시던트 목록 조회

```
[조회 요청]
    │
    ├─► 검색 버튼 클릭 (btnSearch)
    │   └─► 인시던트 목록 조회 함수 호출
    │
    ├─► 실시간 자동 조회 (realCHK 체크 시)
    │   └─► setInterval() - 주기적 조회
    │
    └─► 지금 업데이트 버튼 (btnReload)
        └─► 인시던트 목록 조회 함수 호출

    ▼

[API 호출]
    │
    └─► POST /api/icd/list
        ├─► 파라미터 구성
        │   ├─► 검색 조건 (조회기간, 필터 등)
        │   ├─► 페이지 정보 (pageNum, pageSize)
        │   └─► 정렬 정보
        │
        └─► 응답 데이터
            ├─► 인시던트 목록 (list)
            ├─► 전체 건수 (totalCount)
            └─► 페이징 정보

    ▼

[데이터 바인딩]
    │
    └─► 그리드 데이터 설정
        ├─► gridObj["grid"].resetData(data.list)
        └─► 페이징 정보 업데이트
```

#### 주요 코드 위치
- **조회 함수**: `subIncidentState.jsp:인시던트 목록 조회 함수`
- **API 호출**: `subIncidentState.jsp:fnAjax()`

### 3단계: 인시던트 상세 조회

```
[그리드 행 클릭/더블클릭]
    │
    └─► fnPopupData(incidentId) 호출
        │
        └─► POST /api/icd/detail
            ├─► incidentId 파라미터 전달
            │
            └─► 인시던트 상세 정보 조회
                ├─► 인시던트 기본 정보 (detail)
                ├─► 연관 이벤트 목록 (popEvtList)
                └─► 조치 진행 결과 (checkProc)

    ▼

[팝업 표시]
    │
    └─► fnShowPopup(data) 호출
        ├─► 인시던트 기본 정보 표시
        ├─► 연관 이벤트 목록 표시
        ├─► 담당자 정보 표시
        ├─► 서비스 정보 표시
        └─► 조치 진행 결과 표시
```

#### 주요 코드 위치
- **상세 조회**: `subIncidentStateDetailPopup.jsp:fnPopupData()`
- **팝업 표시**: `subIncidentStateDetailPopup.jsp:fnShowPopup()`

### 4단계: 인시던트 처리

```
[인시던트 정보 수정]
    │
    ├─► 팝업 내 저장 버튼 클릭 (btnIcdResultSave)
    │   └─► POST /api/icd/save
    │       ├─► 담당자 정보 업데이트
    │       ├─► 서비스 정보 업데이트
    │       └─► 조치 내용 수정
    │
    └─► 서비스 정보 업데이트 (updateManualIncidentServiceInfo)
        └─► POST /api/icd/updateManualIncidentServiceInfo

    ▼

[조치 완료 처리]
    │
    └─► 조치완료 버튼 클릭 (btnIcdResultComplete)
        └─► POST /api/icd/end
            ├─► 인시던트 상태를 종료로 변경
            └─► 연관 이벤트 종료 처리

    ▼

[수동 인시던트 생성]
    │
    └─► 등록 버튼 클릭 (btnIncidentCreate)
        └─► 인시던트 등록 팝업 오픈
            └─► POST /api/icd/createManualIncident
                └─► 이벤트 없이 수동으로 인시던트 생성
```

#### 주요 코드 위치
- **정보 수정**: `subIncidentStateDetailPopup.jsp:btnIcdResultSave 클릭 이벤트`
- **조치 완료**: `subIncidentStateDetailPopup.jsp:btnIcdResultComplete 클릭 이벤트`
- **수동 생성**: `subIncidentState.jsp:btnIncidentCreate 클릭 이벤트`

---

## 주요 JavaScript 함수

| 함수명 | 설명 | 위치 |
|--------|------|------|
| `fnPopupData()` | 인시던트 상세 조회 | `subIncidentStateDetailPopup.jsp:513` |
| `fnShowPopup()` | 인시던트 상세 팝업 표시 | `subIncidentStateDetailPopup.jsp:570` |
| `fnInitPopup()` | 팝업 내부 데이터 초기화 | `subIncidentStateDetailPopup.jsp:532` |
| `incidentProcessing()` | 조치중 인시던트 조회 | `subIncidentStateDetailPopup.jsp:646` |
| `incidentCompleted()` | 조치완료 인시던트 조회 | `subIncidentStateDetailPopup.jsp:673` |
| `enableIncidentInputs()` | 컴포넌트 활성화 | `subIncidentStateDetailPopup.jsp:695` |
| `disableIncidentInputs()` | 컴포넌트 비활성화 | `subIncidentStateDetailPopup.jsp` |
| `getEventInfo()` | 이벤트 정보 조회 | `subIncidentStateDetailPopup.jsp` |

---

## 데이터 흐름 다이어그램

```
[사용자 액션]
    │
    ├─► 검색 버튼 클릭
    ├─► 실시간 자동 조회
    ├─► 그리드 행 클릭
    └─► 지금 업데이트 버튼

    ▼

[API 호출]
    │
    ├─► POST /api/icd/list
    │   └─► IcdRestController.list()
    │       └─► IcdService.selectIcdList()
    │           └─► IcdMapper.selectIcdList()
    │
    └─► POST /api/icd/detail
        └─► IcdRestController.detail()
            └─► IcdService.detail()
                └─► IcdMapper.selectIcdDetail()

    ▼

[데이터베이스]
    │
    └─► CMON_INCIDENT_INFO 조회
        ├─► 검색 조건 적용
        ├─► 페이징 처리
        ├─► 연관 이벤트 조회
        └─► 조치 진행 결과 조회

    ▼

[응답 데이터]
    │
    └─► JSON 응답
        ├─► list: 인시던트 목록
        ├─► detail: 인시던트 상세 정보
        ├─► popEvtList: 연관 이벤트 목록
        └─► checkProc: 조치 진행 결과

    ▼

[화면 업데이트]
    │
    └─► 그리드 데이터 바인딩
        ├─► gridObj["grid"].resetData()
        └─► 팝업 데이터 표시
```

---

## 필요한 데이터 (API 요청)

### 인시던트 목록 조회 파라미터

| 필드명 | 타입 | 설명 | 필수 여부 |
|--------|------|------|-----------|
| `pageNum` | Integer | 페이지 번호 | 필수 |
| `pageSize` | Integer | 페이지 크기 | 필수 |
| `startDate` | String | 시작일 | 선택 |
| `startTime` | String | 시작시간 | 선택 |
| `endDate` | String | 종료일 | 선택 |
| `endTime` | String | 종료시간 | 선택 |
| `searchType` | String | 조회 타입 (evtOccu/icdEnd) | 선택 |
| `commonL1` | String | L1 코드 | 선택 |
| `commonL2` | String | L2 코드 | 선택 |
| `commonL3` | String | L3 코드 | 선택 |
| `zone` | String | Zone(L4) | 선택 |
| `kwIncidentId` | String | 인시던트 ID | 선택 |
| `kwIncidentLevel` | String | 인시던트 등급 | 선택 |
| `kwIncidentState` | String | 인시던트 상태 | 선택 |
| `kwCaptain` | String | 관제상황조장 | 선택 |
| `kwRestoreTeam` | String | 복구팀 | 선택 |
| `kwIncidentContents` | String | 이벤트 제목 | 선택 |
| `kwContainerNm` | String | 센터 | 선택 |
| `kwStdnm` | String | 표준서비스(L3) | 선택 |
| `kwItsmIncidentId` | String | ITSM 인시던트 ID | 선택 |
| `kwIncidentServiceImpact` | String | 서비스 영향도 | 선택 |

### 인시던트 상세 조회 파라미터

| 필드명 | 타입 | 설명 | 필수 여부 |
|--------|------|------|-----------|
| `incidentId` | String | 인시던트 ID | 필수 |

### 인시던트 정보 수정 파라미터

| 필드명 | 타입 | 설명 | 필수 여부 |
|--------|------|------|-----------|
| `incidentId` | String | 인시던트 ID | 필수 |
| `incidentLevel` | String | 인시던트 등급 | 선택 |
| `incidentServiceImpact` | String | 서비스 영향도 | 선택 |
| `captain` | String | 관제상황조장 | 선택 |
| `incidentChief` | String | 상황반장 | 선택 |
| `restoreTeam` | String | 복구반장 | 선택 |

---

## 주요 코드 위치

### Controller
- **화면 컨트롤러**: `IcdController.java:30-45`
- **REST 컨트롤러**: `IcdRestController.java`

### Service
- **서비스 인터페이스**: `IcdService.java`
- **서비스 구현**: `IcdServiceImpl.java`

### Mapper
- **매퍼 인터페이스**: `IcdMapper.java`
- **SQL 매핑**: `sqlmap/IcdMapper.xml`

### JSP
- **메인 화면**: `WEB-INF/jsp/icd/subIncidentState.jsp`
- **상세 팝업**: `WEB-INF/jsp/icd/subIncidentStateDetailPopup.jsp`
- **등록 팝업**: `WEB-INF/jsp/icd/popup/subIncidentStateCreatePopup.jsp`
- **서비스 검색 팝업**: `WEB-INF/jsp/icd/popup/subIncidentStateSearchServicePopup.jsp`

---

## 참고 파일 목록

### Controller
- `src/main/java/com/framework/icd/controller/IcdController.java`
- `src/main/java/com/framework/icd/controller/IcdRestController.java`

### Service
- `src/main/java/com/framework/icd/service/IcdService.java`
- `src/main/java/com/framework/icd/service/IcdServiceImpl.java`

### Mapper
- `src/main/java/com/framework/icd/mapper/IcdMapper.java`
- `src/main/resources/sqlmap/IcdMapper.xml`

### JSP
- `src/main/webapp/WEB-INF/jsp/icd/subIncidentState.jsp`
- `src/main/webapp/WEB-INF/jsp/icd/subIncidentStateDetailPopup.jsp`

---

## 작성일
2025-01-27

